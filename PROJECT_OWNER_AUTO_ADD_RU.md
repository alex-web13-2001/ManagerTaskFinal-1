# Автоматическое добавление создателя в участники проекта

## Описание изменений

Реализована критически важная функция: **автоматическое добавление создателя проекта как владельца (OWNER)** в таблицу `ProjectMember` с использованием транзакции Prisma для обеспечения атомарности операций.

## Цель

Гарантировать, что пользователь, создавший проект, автоматически становится его владельцем (OWNER) с правами доступа через систему контроля доступа на основе ролей.

## Технические детали

### Созданные файлы

1. **`src/server/handlers/projectHandlers.ts`**
   - Новый файл обработчика проектов
   - Содержит функцию `createProject`
   - Использует Prisma транзакции для атомарности операций

### Измененные файлы

1. **`src/server/index.ts`**
   - Добавлен импорт `createProject` из `handlers/projectHandlers.js`
   - Заменена inline реализация на вызов обработчика
   - Сокращен код на ~60 строк

### Реализация

```typescript
export async function createProject(req: Request, res: Response) {
  try {
    const { name, description, color } = req.body;
    const ownerId = (req as any).user!.sub;

    if (!name) {
      return res.status(400).json({ error: 'Название проекта обязательно' });
    }

    // Используем транзакцию для обеспечения атомарности:
    // Обе операции выполнятся успешно, либо не выполнится ни одна
    const project = await prisma.$transaction(async (tx) => {
      // Шаг 1: Создать проект
      const newProject = await tx.project.create({
        data: {
          name,
          description: description || null,
          color: color || '#3b82f6',
          ownerId: ownerId,
        },
      });

      // Шаг 2: Добавить владельца как участника с ролью 'owner'
      await tx.projectMember.create({
        data: {
          userId: ownerId,
          projectId: newProject.id,
          role: 'owner',
        },
      });

      return newProject;
    });

    // Получить проект со всеми связанными данными
    const projectWithMembers = await prisma.project.findUnique({
      where: { id: project.id },
      include: {
        owner: { select: { id: true, name: true, email: true, avatarUrl: true } },
        members: {
          include: {
            user: { select: { id: true, name: true, email: true, avatarUrl: true } },
          },
        },
      },
    });

    res.status(201).json(projectWithMembers);
  } catch (error: any) {
    console.error('Не удалось создать проект или запись участника проекта:', error);
    res.status(500).json({ error: 'Не удалось создать проект' });
  }
}
```

## Ключевые преимущества

### 1. Атомарность операций
- Использование `prisma.$transaction` гарантирует, что обе операции (создание проекта и добавление владельца) выполнятся как единое целое
- Если одна операция не выполнится, откатятся обе
- Это предотвращает создание "осиротевших" проектов без владельцев

### 2. Целостность данных
- Владелец проекта всегда присутствует в таблице `ProjectMember` с ролью 'owner'
- Система контроля доступа работает корректно сразу после создания проекта
- Нет "гонки условий" между созданием проекта и добавлением владельца

### 3. Улучшенная структура кода
- Логика создания проекта вынесена в отдельный файл
- Код более читаемый и поддерживаемый
- Легче тестировать и расширять функциональность

### 4. Безопасность
- Прошла проверка CodeQL без обнаружения проблем
- Правильная обработка ошибок
- Информативные сообщения об ошибках на русском языке

## Тестирование

### Автоматический тест

Создан файл `test_create_project_handler.ts` для проверки функциональности:

```bash
npx tsx test_create_project_handler.ts
```

Тест проверяет:
1. ✅ Создание проекта с транзакцией
2. ✅ Автоматическое добавление владельца как участника
3. ✅ Корректность роли владельца ('owner')
4. ✅ Получение данных проекта со связанными участниками

### Ручное тестирование

1. Запустить сервер:
```bash
npm run dev:server
```

2. Создать проект через API:
```bash
curl -X POST http://localhost:3001/api/projects \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <ваш_токен>" \
  -d '{"name": "Тестовый проект", "description": "Описание", "color": "#3b82f6"}'
```

3. Проверить, что владелец добавлен в участники:
```bash
curl http://localhost:3001/api/projects/<project_id>/members \
  -H "Authorization: Bearer <ваш_токен>"
```

## Совместимость

- ✅ Полностью обратно совместима с существующим кодом
- ✅ Не требует миграций базы данных
- ✅ Не меняет API контракт
- ✅ Работает с существующей системой аутентификации

## Проверка безопасности

Проведена проверка CodeQL:
- **Результат:** 0 проблем безопасности
- **Статус:** ✅ Пройдено

## Следующие шаги

Рекомендуется:
1. Протестировать на staging окружении с реальной базой данных
2. Проверить работу с существующими проектами
3. Убедиться, что права доступа работают корректно
4. Проверить производительность при создании большого количества проектов

## Вопросы и поддержка

При возникновении проблем:
1. Проверьте логи сервера
2. Убедитесь, что база данных доступна
3. Проверьте, что Prisma клиент сгенерирован (`npx prisma generate`)
4. Запустите тесты для проверки функциональности

## Примечания

- Все комментарии в коде на русском языке согласно требованиям
- Сообщения об ошибках на русском языке для пользователей
- Код следует стилю и конвенциям проекта
